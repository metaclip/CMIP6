library(rvest)
source("R/model_component_helpers.R")

## /////////////////////////////////////////////////////////////////////////////
## Master dataset table, imported from 'metaclipR_C3S-CICA' repo:
## /////////////////////////////////////////////////////////////////////////////

master <- read.csv("https://raw.githubusercontent.com/metaclip/metaclipR_C3S-CICA/main/inst/master_datasets.csv")
# names(master)


## /////////////////////////////////////////////////////////////////////////////
## CREATE OWL FILE
## /////////////////////////////////////////////////////////////////////////////

## OWL template file (contains header and imports)
## Use 'restart.owl()' to start from blank template
## The template already contains the OWL header with relevant imports and metadata
## Please check the 'datasource' ontology version dependency

owl.file <- "CMIP6-datasets.owl"
restart.owl(voc = "datasets", version = "0.0")


# Open file in add mode
con <- file(owl.file, open = "a")

## VOC URI
voc <- "https://raw.githubusercontent.com/metaclip/CMIP6/main/CMIP6-datasets.owl"


for (i in 1:nrow(master)) {
    
    cat("\n\n\n", file = con, append = TRUE)
    
    inst <- paste("CMIP6",
                  master[i, "model_ID"],
                  master[i, "experiment"],
                  sep = ".")
    # NamedIndividual instance
    instance <- paste0(voc, "#", inst)
    
    # Metadata extraction from parsed html
    url <- master[i,"doi"]
    parsed <- read_html(url)
    # doi <- parsed %>% html_node("meta[name='DC.identifier']") %>% html_attr("content")
    
    cat("\t<!--\n", file = con, append = TRUE)
    cat("\t\t", instance, "\n", file = con, append = TRUE)
    cat("\t-->\n", file = con, append = TRUE)
    
    ## Write Variable individual and class -------------------------------------
    
    cat("\n", file = con, append = TRUE)
    cat("\t<owl:NamedIndividual rdf:about=\"", instance, "\">",
        sep = "", file = con, append = TRUE)
    cat("\n", file = con, append = TRUE)
    cat("\t\t<rdf:type rdf:resource=\"https://www.metaclip.org/datasource/datasource.owl#MultiDecadalSimulation\"/>",
        file = con, append = TRUE)
    cat("\n", file = con, append = TRUE)
    
    ## Additional properties ---------------------------------------------------
    
    ## Dataset label
    cat("\t\t<rdfs:label>", inst, "</rdfs:label>", sep = "",
        file = con, append = TRUE)
    cat("\n", file = con, append = TRUE)
    
    ## Title
    title <- parsed %>% html_node("meta[name='DC.title']") %>% html_attr("content")
    cat("\t\t<dc:title xml:lang=\"en\">", title,
        "</dc:title>", sep = "", file = con, append = TRUE)
    cat("\n", file = con, append = TRUE)
    
    ## DOI
    cat("\t\t<dc:identifier rdf:datatype=\"http://www.w3.org/2001/XMLSchema#anyURI\">",
        url, "</dc:identifier>", sep = "", file = con, append = TRUE)
    cat("\n", file = con, append = TRUE)
    
    ## Publisher
    publisher <- parsed %>% html_node("meta[name='DC.publisher']") %>% html_attr("content")
    cat("\t\t<terms:publisher xml:lang=\"en\">", publisher,
        "</terms:publisher>", sep = "", file = con, append = TRUE)
    cat("\n", file = con, append = TRUE)
    
    ## Creator
    creator <- parsed %>% html_node("meta[name='DC.creator']") %>% html_attr("content")
    cat("\t\t<terms:creator>", creator,
        "</terms:creator>", sep = "", file = con, append = TRUE)
    cat("\n", file = con, append = TRUE)
    
    ## Release year
    rel_year <- parsed %>% html_node("meta[name='DC.date']") %>% html_attr("content")
    cat("\t\t<dc:date rdf:datatype=\"http://www.w3.org/2001/XMLSchema#string\">",
        rel_year, "</dc:date>", sep = "", file = con, append = TRUE)
    cat("\n", file = con, append = TRUE)

        cat("\t</owl:NamedIndividual>\n", file = con, append = TRUE)
    cat("\n", file = con, append = TRUE)
}

cat("</rdf:RDF>\n\n", sep = "", file = con, append = TRUE)

cat("<!-- ", file = con, append = TRUE)
cat("Automatically generated by '3_import_CMIP6_datasets.R' on", as.character(Sys.Date()),
    "using", gsub("\\(.*", "", R.version.string),
    "<https://github.com/METACLIP/CMIP6>", file = con, append = TRUE)
cat(" -->\n", file = con, append = TRUE)
## Close connection 
close(con)

